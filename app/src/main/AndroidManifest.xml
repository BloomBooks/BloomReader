<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="org.sil.bloom.reader"
    android:installLocation="auto">

    <!-- Normal Permissions - granted by being in Manifest -->
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <!-- So that just for the duration of WiFi transfer we can hold a lock. -->
    <uses-permission android:name="android.permission.WAKE_LOCK"/>
    <!-- Used at least for analytics, soon for Bloom Library download. Was present when I added
    analytics, so may be used for something else also. -->
    <uses-permission android:name="android.permission.INTERNET" />
    <!-- On later versions of Android this seems to be needed for receiving UDP broadcasts. -->
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <!-- On later versions of Android this seems to be needed for receiving UDP broadcasts. -->
    <uses-permission android:name="android.permission.CHANGE_WIFI_MULTICAST_STATE" />
    <!-- currently just because it's how we get the device name for WiFi, but eventually we will have
    other Bluetooth functions. -->
    <uses-permission android:name="android.permission.BLUETOOTH"/>

    <!-- Dangerous Permissions - must be requested at runtime -->
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />

    <application
        android:name=".BloomReaderApplication"
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:supportsRtl="true"
        android:theme="@style/AppTheme">
        <!-- Some activities which declare android:theme="@style/AppTheme.NoActionBar" actually
        do have action bars, but we're choosing to configure a toolbar as our action bar
        using setSupportActionBar() -->
        <activity
            android:name=".MainActivity"
            android:label="@string/app_name"
            android:theme="@style/AppTheme.NoActionBar"
            android:configChanges="keyboardHidden|orientation|screenSize|screenLayout">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>

            <!--
                We have three intent filters to detect when another app is trying to send us a bloom
                file. Principally this is aimed at being able to open Bloom files from File Manager
                apps. The parameters included in the intent depend on the File Manager sending it,
                so we need a variety of filters to support as many sending apps as possible.
                 - The first filter checks the file extension on intents where a MIME type
                is not set.
                 - The second filter checks the file extensions where a MIME type is set.
                Both are necessary because the sending app may or may not choose to
                include the MIME type. The MIME type is set to */* because the MIME
                type in the intent may be incorrect since our filetype is a unique one.
                Since we're still filtering by file extension, this is ok.
                 - The third filter will catch an intent if the MIME type is correct
                but the file extension is not what we expected. This should be an
                unusual case.
            -->
            <!-- Matches intents by file extension when no MIME type is set -->
            <intent-filter
                android:icon="@drawable/book"
                android:label="@string/app_name">
                <action android:name="android.intent.action.VIEW" />

                <category android:name="android.intent.category.BROWSABLE" />
                <category android:name="android.intent.category.DEFAULT" />

                <data android:scheme="content" />
                <data android:scheme="file" />
                <data android:host="*" />
                <data android:pathPattern=".*bloomd" />
                <data android:pathPattern=".*bloombundle" />
            </intent-filter>

            <!-- Match intents by file extension when a MIME type is set -->
            <intent-filter
                android:icon="@drawable/book"
                android:label="@string/app_name">
                <action android:name="android.intent.action.VIEW" />

                <category android:name="android.intent.category.BROWSABLE" />
                <category android:name="android.intent.category.DEFAULT" />

                <data android:mimeType="*/*" />

                <data android:scheme="content" />
                <data android:scheme="file" />
                <data android:host="*" />
                <data android:pathPattern=".*bloomd" />
                <data android:pathPattern=".*bloombundle" />
            </intent-filter>

            <!-- Match intents by MIME type in case the file extension gets lost -->
            <intent-filter
                android:icon="@drawable/book"
                android:label="@string/app_name">
                <action android:name="android.intent.action.VIEW" />

                <category android:name="android.intent.category.BROWSABLE" />
                <category android:name="android.intent.category.DEFAULT" />

                <data android:scheme="content" />
                <data android:scheme="file" />
                <!-- Sometimes the MIME type we get is not exactly what we set - hence the variety of options -->
                <data android:mimeType="application/vnd.bloom" />
                <data android:mimeType="application/bloom" />
                <data android:mimeType="application/vnd.bloomd" />
                <data android:mimeType="application/bloomd" />
                <data android:mimeType="application/vnd.bloombundle" />
                <data android:mimeType="application/bloombundle" />
            </intent-filter>
        </activity>
        <activity
            android:name=".ReaderActivity"
            android:label="@string/app_name"
            android:theme="@style/AppTheme.NoActionBar"
            android:configChanges="keyboardHidden|orientation|screenSize|screenLayout" />

        <service
            android:name=".WiFi.NewBookListenerService"
            android:enabled="true"
            android:exported="true" />
        <service
            android:name=".WiFi.SyncService"
            android:enabled="true"
            android:exported="true" />

        <activity
            android:name=".WiFi.GetFromWiFiActivity"
            android:label="@string/app_name"
            android:excludeFromRecents="true"
            android:theme="@style/WiFiDialogTheme"></activity>
        <activity
            android:name=".ShelfActivity"
            android:label="@string/app_name"
            android:theme="@style/AppTheme.NoActionBar"></activity>

        <receiver android:name="org.sil.bloom.reader.ConnectivityReceiver"
            android:enabled="true">
            <intent-filter>
                <action android:name="android.net.conn.CONNECTIVITY_CHANGE" />
            </intent-filter>
        </receiver>

        <provider
            android:authorities="${applicationId}.fileprovider"
            android:name="android.support.v4.content.FileProvider"
            android:grantUriPermissions="true"
            android:exported="false">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/filepaths" />
        </provider>
    </application>

</manifest>